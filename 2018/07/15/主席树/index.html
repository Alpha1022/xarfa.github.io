<!DOCTYPE html>
<html>
  <!-- Html Head Tag-->
  <head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="ARFA">
  <!-- Open Graph Data -->
  <meta property="og:title" content="主席树"/>
  <meta property="og:description" content="" />
  <meta property="og:site_name" content="ARFA"/>
  <meta property="og:type" content="article" />
  <meta property="og:image" content="http://yoursite.com"/>
  
    <link rel="alternate" href="/atom.xml" title="ARFA" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  

  <!-- Site Title -->
  <title>ARFA</title>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <!-- Custom CSS -->
  
  <link rel="stylesheet" href="/css/style.dark.css">

  <!-- Google Analytics -->
  

</head>

  <body>
    <!-- Page Header -->


<header class="site-header header-background" style="background-image: url(/img/default-banner-dark.jpg)">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="page-title with-background-image">
          <p class="title">主席树</p>
          <p class="subtitle"></p>
        </div>
        <div class="site-menu with-background-image">
          <ul>
            
              <li>
                <a href="/">
                  
                  Home
                  
                </a>
              </li>
            
              <li>
                <a href="/archives">
                  
                  Archives
                  
                </a>
              </li>
            
              <li>
                <a href="https://github.com/xarfa">
                  
                  Github
                  
                </a>
              </li>
            
              <li>
                <a href="https://www.luogu.org/space/show?uid=77760">
                  
                  Luogu
                  
                </a>
              </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</header>

<article>
  <div class="container typo">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-info text-muted">
          
            <!-- Author -->
            <span class="author info">By ARFA</span>
          
          <!-- Date -->
          <span class="date-time info">On
            <span class="date">2018-07-15</span>
            <span class="time">20:45:55</span>
          </span>
          
          <!--  Categories  -->
            <span class="categories info">Under 

<a href="/categories/数据结构/">数据结构</a>
</span>
          
        </div>
        <!-- Tags -->
        
        <!-- Post Main Content -->
        <div class="post-content">
          <blockquote>
<h2 id="最详细的静态主席树讲解"><a href="#最详细的静态主席树讲解" class="headerlink" title="最详细的静态主席树讲解"></a>最详细的静态主席树讲解</h2></blockquote>
<h3 id="I-基础"><a href="#I-基础" class="headerlink" title="I.基础"></a>I.基础</h3><p>主席树总的来说就是权值线段树的一种变法,也就是一种<del>非主流</del>的线段树。所以我们需要对线段树有深刻理解。光光AC线段树1和线段树2是远远不够的。以下推荐这几个材料:</p>
<a id="more"></a>
<p>1.<a href="https://blog.csdn.net/a1351937368/article/details/78884465" target="_blank" rel="noopener">Blog</a> 这篇博客感觉还是不错,特别就是后面的几个知识点,是一个线段树的扩张。</p>
<p>2.<a href="https://blog.csdn.net/qq_36721333/article/details/76890179" target="_blank" rel="noopener">权值线段树</a>简单了解以下。</p>
<p>3.<a href="https://www.luogu.org/problemnew/show/P1801" target="_blank" rel="noopener">Luogu 1801</a>尽量用权值线段树做,不要用<del>堆</del>。</p>
<p>4.推荐一道<del>水题</del> <a href="https://www.luogu.org/problemnew/show/T33598" target="_blank" rel="noopener">Alice的游戏</a>,题目原链接:<a href="https://jzoj.net/senior/#contest/show/2373/3" target="_blank" rel="noopener">攒送们</a> </p>
<hr>
<h3 id="II-前言-背景"><a href="#II-前言-背景" class="headerlink" title="II.前言/背景"></a>II.前言/背景</h3><h4 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h4><p>为什么叫主席树?这可能是很多人的疑问。</p>
<p>如果我<del>没有记错</del>,应该就是第23个人,<a href="http://hf.aoshu.com/e/20130221/51257fb327e57.shtml" target="_blank" rel="noopener">网页</a>。</p>
<p>没错,他就叫黄嘉泰,那么把拼音取出来:<a href="http://www.china.com.cn/policy/txt/2012-06/21/content_25703715.htm" target="_blank" rel="noopener">hjt</a>。就是我们伟大的主席。</p>
<h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>1.先致谢几个大佬:</p>
<ul>
<li>洛谷所有写了题解的大佬</li>
<li><a href="https://www.luogu.org/space/show?uid=64030" target="_blank" rel="noopener">ZJJ</a>和<a href="https://www.luogu.org/space/show?uid=77245" target="_blank" rel="noopener">GSM</a>大佬</li>
<li>远航休息站</li>
</ul>
<p>2.<del><strong>此篇博客没有任何政治主张</strong></del></p>
<p>3.主席树就是一个垃圾回收的权值线段树,其实很简单,实现由一点难。(建议改为普及+ ~ 提高-)</p>
<hr>
<h3 id="III-权值线段树-做区间第k大"><a href="#III-权值线段树-做区间第k大" class="headerlink" title="III.权值线段树 - 做区间第k大"></a>III.权值线段树 - 做区间第k大</h3><p>好了废话完了,我们步入正题。如果你已经做完,看完了上面的基础部分,那么已经知道这道题的<del>部分做法</del>了,我这里就重新讲解权值线段树。</p>
<p>权值线段树很简单,它的点维护的只是值出现的次数。什么意思?看图:</p>
<p><img src="https://cdn.luogu.org/upload/pic/21888.png" alt=""></p>
<p>这个很容易理解,那么我们怎样求<strong>第K大</strong>呢。步骤<br><figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>.我到达了这个节点,如果左儿子的权值&lt;k,那么说明k不在左子树,往右走,并K值减去左儿子的权值。</span><br><span class="line"><span class="number">2</span>.如果左儿子的权值&gt;=k,k一定在左子树里面,直接往左走。</span><br></pre></td></tr></table></figure></p>
<p>就是这样:</p>
<p><img src="https://cdn.luogu.org/upload/pic/21892.png" alt=""></p>
<p>但是它要求的是<strong>区间第k大</strong>,怎么办?</p>
<p>我们保存每一次数值修改后的线段树,然后查找u,v这个区间的时候,就可以对两颗线段树进行点对点相减。然后塑造一个”<strong>差分后的线段树</strong>“,对它进行如上操作。</p>
<p><img src="https://cdn.luogu.org/upload/pic/21895.png" alt=""></p>
<p>假如我们要求以上数据的2~4区间第2大,就是这样子的</p>
<p><img src="https://cdn.luogu.org/upload/pic/21898.png" alt=""></p>
<p>然后求出<strong>第k大</strong>就可以了。</p>
<figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Find</span><span class="params">(l,r:longint)</span>:</span>longint; <span class="comment">//返回寻找的值</span></span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">        dix,mid:longint; <span class="comment">//dix是两颗线段树的相差</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> l=r <span class="keyword">then</span> <span class="comment">//答案</span></span><br><span class="line">                <span class="keyword">exit</span>(diss[l]);</span><br><span class="line"></span><br><span class="line">        dix:=node[left[node_2]]-node[left[node_1]]; <span class="comment">//差分</span></span><br><span class="line"></span><br><span class="line">        mid:=(l+r) <span class="keyword">div</span> <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> dix&gt;=k <span class="keyword">then</span> <span class="comment">//往左边走</span></span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">                node_1:=left[node_1]; <span class="comment">//两颗线段树节点一起往左</span></span><br><span class="line">                node_2:=left[node_2];</span><br><span class="line">                Find:=Find(l,mid); <span class="comment">//递归</span></span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> dix&lt;k <span class="keyword">then</span> <span class="comment">//往右边</span></span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">                dec(k,dix);</span><br><span class="line">                node_1:=right[node_1];</span><br><span class="line">                node_2:=right[node_2];</span><br><span class="line">                Find:=Find(mid+<span class="number">1</span>,r);</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="IV-空间压缩·垃圾回收"><a href="#IV-空间压缩·垃圾回收" class="headerlink" title="IV.空间压缩·垃圾回收"></a>IV.空间压缩·垃圾回收</h3><p>那么多线段树,<del>不卡死你才怪</del>。</p>
<p>我们会发现,这里修改的时候就只有一个log(一条链)的会修改!那我们就可以垃圾回收了!!!</p>
<p>我们要知道什么是<strong>改变</strong>,什么是<strong>垃圾</strong>。</p>
<p><img src="https://cdn.luogu.org/upload/pic/21899.png" alt=""></p>
<p>这个需要贴一下代码:</p>
<figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">procedure</span> <span class="title">Query</span><span class="params">(l,r,key:longint)</span>;</span> <span class="comment">//左右区间,key是修改的点的编号,上图的修改的点的编号就是2,第2个。</span></span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">        mid:longint;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">		<span class="comment">//注:now就是前一个历史线段树</span></span><br><span class="line">        inc(cnt); <span class="comment">//动态开点</span></span><br><span class="line">        node[cnt]:=node[now]+<span class="number">1</span>; <span class="comment">//直接</span></span><br><span class="line">        <span class="keyword">if</span> l=r <span class="keyword">then</span> <span class="comment">//到了叶子节点</span></span><br><span class="line">                <span class="keyword">exit</span>;</span><br><span class="line">        mid:=(l+r) <span class="keyword">div</span> <span class="number">2</span>; <span class="comment">//中间</span></span><br><span class="line">        <span class="keyword">if</span> key&lt;=mid <span class="keyword">then</span> <span class="comment">//往左边建立新的节点</span></span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">                left[cnt]:=cnt+<span class="number">1</span>; <span class="comment">//新节点的左儿子绝对是cnt+1,思考</span></span><br><span class="line">                right[cnt]:=right[now]; <span class="comment">//右边是历史线段树的右边,垃圾回收</span></span><br><span class="line">                now:=left[now]; <span class="comment">//往左</span></span><br><span class="line">                Query(l,mid,key); <span class="comment">//往左</span></span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line">        <span class="keyword">if</span> key&gt;mid <span class="keyword">then</span> <span class="comment">//往右边建立新的节点</span></span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">                right[cnt]:=cnt+<span class="number">1</span>; <span class="comment">//同上</span></span><br><span class="line">                left[cnt]:=left[now];</span><br><span class="line">                now:=right[now];</span><br><span class="line">                Query(mid+<span class="number">1</span>,r,key);</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<p>顺便一提,权值线段树+垃圾回收=主席树。</p>
<hr>
<h3 id="VI-离散化"><a href="#VI-离散化" class="headerlink" title="VI.离散化"></a>VI.离散化</h3><p>我不知道我会不会真正的离散化,但是我是这样子做的:</p>
<figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>.给每第i个数字给一个编号i。</span><br><span class="line"><span class="number">2</span>.排序,要把编号一起转换。</span><br><span class="line"><span class="number">3</span>.去掉重复,给予线段树编号</span><br><span class="line"><span class="number">4</span>.再开一个桶,存储此主席树编号对应的原数组的数是什么。</span><br></pre></td></tr></table></figure>
<p>代码:</p>
<figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">procedure</span> <span class="title">ready</span>;</span></span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">        dis_:longint;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">        dis_:=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">read</span>(n,m);</span><br><span class="line">        <span class="keyword">for</span> i:=<span class="number">1</span> <span class="keyword">to</span> n <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">                <span class="keyword">read</span>(num[i]); <span class="comment">//值</span></span><br><span class="line">                place[i]:=i; <span class="comment">//原数组编号</span></span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line">        Sort(<span class="number">1</span>,n); <span class="comment">//排序</span></span><br><span class="line">        num[<span class="number">0</span>]:=-<span class="number">1000000007</span>; <span class="comment">//血的教训</span></span><br><span class="line">        <span class="keyword">for</span> i:=<span class="number">1</span> <span class="keyword">to</span> n <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">                <span class="keyword">if</span> num[i]&lt;&gt;num[i-<span class="number">1</span>] <span class="keyword">then</span> <span class="comment">//去重</span></span><br><span class="line">                        inc(dis_);</span><br><span class="line">                dis[place[i]]:=dis_; <span class="comment">//原数组的数字的主席树编号是</span></span><br><span class="line">                diss[dis[place[i]]]:=num[i]; <span class="comment">//主席树的编号对应的原数组</span></span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line">        dis_num:=dis_; <span class="comment">//去重后的数字个数</span></span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<p>如果我们找到了l=r,也就是答案,那么就直接输出:<br><figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">writeln(diss[l(或者是r,没有关系)]);</span><br></pre></td></tr></table></figure></p>
<hr>
<h3 id="VII-存储结构-动态开点"><a href="#VII-存储结构-动态开点" class="headerlink" title="VII.存储结构/动态开点"></a>VII.存储结构/动态开点</h3><p>我们不能用树的性质来存储节点,索性就直接存储。如果我们需要开启一个新的节点,包括几个东西:</p>
<figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>.node 节点的权值</span><br><span class="line"><span class="number">2</span>.left 左儿子的位置</span><br><span class="line"><span class="number">3</span>.right 右儿子的位置</span><br></pre></td></tr></table></figure>
<p>注意一下就可以了。</p>
<figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>.修改(query)的时候,因为下一个点肯定就是cnt+<span class="number">1</span>,直接赋值(左儿子或右儿子)。</span><br><span class="line"><span class="number">2</span>.Build了解一下</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="VIII-Build"><a href="#VIII-Build" class="headerlink" title="VIII.Build"></a>VIII.Build</h3><p>一开始我们要建造一个空的线段树,为什么?因为有事后会玄学WA。但是本题目不用,还能省掉很多时间复杂度。贴代码:</p>
<figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Build</span><span class="params">(l,r:longint)</span>:</span>longint; <span class="comment">//Build返回的是儿子的节点</span></span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">        mid,now:longint;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">        inc(cnt); <span class="comment">//动态开点</span></span><br><span class="line">        now:=cnt; <span class="comment">//存储现在节点的位置</span></span><br><span class="line">        node[now]:=<span class="number">0</span>; <span class="comment">//就是空树</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> l=r <span class="keyword">then</span> <span class="comment">//叶子</span></span><br><span class="line">                <span class="keyword">exit</span>(now);</span><br><span class="line"></span><br><span class="line">        mid:=(l+r) <span class="keyword">div</span> <span class="number">2</span>;</span><br><span class="line">        left[now]:=Build(l,mid); <span class="comment">//左儿子节点</span></span><br><span class="line">        right[now]:=Build(mid+<span class="number">1</span>,r); <span class="comment">//右儿子节点</span></span><br><span class="line">        <span class="keyword">exit</span>(now); <span class="comment">//返回本节点编号,递归思想</span></span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="IX-安利-CODE"><a href="#IX-安利-CODE" class="headerlink" title="IX.安利/CODE"></a>IX.安利/CODE</h3><p>顺便安利一下我的个拓本博客:<a href="https://xarfa.github.io/" target="_blank" rel="noopener">传送门</a>,感觉还是不错的。</p>
<figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//上面已经讲了很多,不再加注释。</span></span><br><span class="line"><span class="comment">//如果想快一点,把Build删掉。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// luogu-judger-enable-o2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">        left,right,node:<span class="keyword">array</span>[-<span class="number">1</span>..<span class="number">4000440</span>] <span class="keyword">of</span> longint;</span><br><span class="line">        num,root:<span class="keyword">array</span>[-<span class="number">1</span>..<span class="number">200100</span>] <span class="keyword">of</span> longint;</span><br><span class="line">        place,dis,diss:<span class="keyword">array</span>[-<span class="number">1</span>..<span class="number">200100</span>] <span class="keyword">of</span> longint;</span><br><span class="line">        i,j,n,m,u,v,k,cnt,now,t,d,dis_num:longint;</span><br><span class="line">        node_1,node_2:longint;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">procedure</span> <span class="title">Sort</span><span class="params">(l,r:longint)</span>;</span></span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">    i,j,s,t:longint;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    i:=l; j:=r; s:=num[(l+r) <span class="keyword">div</span> <span class="number">2</span>];</span><br><span class="line">        <span class="keyword">repeat</span></span><br><span class="line">                <span class="keyword">while</span> num[i]&lt;s <span class="keyword">do</span> inc(i);</span><br><span class="line">                <span class="keyword">while</span> num[j]&gt;s <span class="keyword">do</span> dec(j);</span><br><span class="line">                <span class="keyword">if</span> i&lt;=j <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">begin</span></span><br><span class="line">                        t:=num[i]; num[i]:=num[j]; num[j]:=t;</span><br><span class="line">                        t:=place[i]; place[i]:=place[j]; place[j]:=t;</span><br><span class="line">                inc(i); dec(j);</span><br><span class="line">                <span class="keyword">end</span>;</span><br><span class="line">        <span class="keyword">until</span> i&gt;=j;</span><br><span class="line">        <span class="keyword">if</span> i&lt;r <span class="keyword">then</span> Sort(i,r);</span><br><span class="line">        <span class="keyword">if</span> j&gt;l <span class="keyword">then</span> Sort(l,j);</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">procedure</span> <span class="title">ready</span>;</span></span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">        dis_:longint;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">        dis_:=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">read</span>(n,m);</span><br><span class="line">        <span class="keyword">for</span> i:=<span class="number">1</span> <span class="keyword">to</span> n <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">                <span class="keyword">read</span>(num[i]);</span><br><span class="line">                place[i]:=i;</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line">        Sort(<span class="number">1</span>,n);</span><br><span class="line">        num[<span class="number">0</span>]:=-<span class="number">1000000007</span>;</span><br><span class="line">        <span class="keyword">for</span> i:=<span class="number">1</span> <span class="keyword">to</span> n <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">                <span class="keyword">if</span> num[i]&lt;&gt;num[i-<span class="number">1</span>] <span class="keyword">then</span></span><br><span class="line">                        inc(dis_);</span><br><span class="line">                dis[place[i]]:=dis_;</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line">        <span class="keyword">for</span> i:=<span class="number">1</span> <span class="keyword">to</span> n <span class="keyword">do</span></span><br><span class="line">                diss[dis[place[i]]]:=num[i];</span><br><span class="line">        dis_num:=dis_;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Build</span><span class="params">(l,r:longint)</span>:</span>longint;</span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">        mid,now:longint;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">        inc(cnt);</span><br><span class="line">        now:=cnt;</span><br><span class="line">        node[now]:=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> l=r <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">exit</span>(now);</span><br><span class="line"></span><br><span class="line">        mid:=(l+r) <span class="keyword">div</span> <span class="number">2</span>;</span><br><span class="line">        left[now]:=Build(l,mid);</span><br><span class="line">        right[now]:=Build(mid+<span class="number">1</span>,r);</span><br><span class="line">        <span class="keyword">exit</span>(now);</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">procedure</span> <span class="title">Query</span><span class="params">(l,r,key:longint)</span>;</span></span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">        mid:longint;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">        inc(cnt);</span><br><span class="line">        node[cnt]:=node[now]+<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> l=r <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">exit</span>;</span><br><span class="line"></span><br><span class="line">        mid:=(l+r) <span class="keyword">div</span> <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> key&lt;=mid <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">                left[cnt]:=cnt+<span class="number">1</span>;</span><br><span class="line">                right[cnt]:=right[now];</span><br><span class="line">                now:=left[now];</span><br><span class="line">                Query(l,mid,key);</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> key&gt;mid <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">                right[cnt]:=cnt+<span class="number">1</span>;</span><br><span class="line">                left[cnt]:=left[now];</span><br><span class="line">                now:=right[now];</span><br><span class="line">                Query(mid+<span class="number">1</span>,r,key);</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Find</span><span class="params">(l,r:longint)</span>:</span>longint;</span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">        dix,mid:longint;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> l=r <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">exit</span>(diss[l]);</span><br><span class="line"></span><br><span class="line">        dix:=node[left[node_2]]-node[left[node_1]];</span><br><span class="line"></span><br><span class="line">        mid:=(l+r) <span class="keyword">div</span> <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> dix&gt;=k <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">                node_1:=left[node_1];</span><br><span class="line">                node_2:=left[node_2];</span><br><span class="line">                Find:=Find(l,mid);</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> dix&lt;k <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">                dec(k,dix);</span><br><span class="line">                node_1:=right[node_1];</span><br><span class="line">                node_2:=right[node_2];</span><br><span class="line">                Find:=Find(mid+<span class="number">1</span>,r);</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">procedure</span> <span class="title">Chair_Tree</span>;</span></span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">        i,j:longint;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">        Build(<span class="number">1</span>,dis_num);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i:=<span class="number">1</span> <span class="keyword">to</span> n <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">                root[i]:=cnt+<span class="number">1</span>;</span><br><span class="line">                now:=root[i-<span class="number">1</span>];</span><br><span class="line">                Query(<span class="number">1</span>,dis_num,dis[i]);</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i:=<span class="number">1</span> <span class="keyword">to</span> m <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">                <span class="keyword">read</span>(u,v,k);</span><br><span class="line">                node_1:=root[u-<span class="number">1</span>];</span><br><span class="line">                node_2:=root[v];</span><br><span class="line">                writeln(Find(<span class="number">1</span>,dis_num));</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">        Ready;</span><br><span class="line">        Chair_Tree;</span><br><span class="line"><span class="keyword">end</span>.</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="7-15-更新"><a href="#7-15-更新" class="headerlink" title="7/15 更新"></a>7/15 更新</h3><p>最近看到一些静态主席树的题目。我们知道静态主席树不仅仅可以做”可持久化线段树”,而且还可以做”可持久化数组”,而时间、空间复杂度都不会比想出来如何用其他数据结构来做”可持久化数组”慢、大非常非常多,并且非常可观。</p>
<p>所以我这里有一道例题,大家脑AC吧:</p>
<h3 id="3794-【NOIP2014模拟8-20】高级打字机-Standard-IO"><a href="#3794-【NOIP2014模拟8-20】高级打字机-Standard-IO" class="headerlink" title="3794. 【NOIP2014模拟8.20】高级打字机 (Standard IO)"></a>3794. 【NOIP2014模拟8.20】高级打字机 (Standard IO)</h3><h4 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">早苗入手了最新的高级打字机。最新款自然有着与以往不同的功能，那就是它具备撤销功能，厉害吧。</span><br><span class="line">请为这种高级打字机设计一个程序，支持如下3种操作：</span><br><span class="line">T x：在文章末尾打下一个小写字母x。(type操作)</span><br><span class="line">U x：撤销最后的x次修改操作。（Undo操作）（注意Query操作并不算修改操作）</span><br><span class="line">Q x：询问当前文章中第x个字母并输出。（Query操作）文章一开始可以视为空串。</span><br></pre></td></tr></table></figure>
<h4 id="Input"><a href="#Input" class="headerlink" title="Input"></a>Input</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">第1行：一个整数n，表示操作数量。</span><br><span class="line">以下n行，每行一个命令。保证输入的命令合法。</span><br></pre></td></tr></table></figure>
<h4 id="Output"><a href="#Output" class="headerlink" title="Output"></a>Output</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">每行输出一个字母，表示Query操作的答案。</span><br></pre></td></tr></table></figure>
<h4 id="Sample-Input-Output"><a href="#Sample-Input-Output" class="headerlink" title="Sample Input / Output"></a>Sample Input / Output</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">7</span><br><span class="line">T a</span><br><span class="line">T b</span><br><span class="line">T c</span><br><span class="line">Q 2</span><br><span class="line">U 2</span><br><span class="line">T c</span><br><span class="line">Q 2</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">b</span><br><span class="line">c</span><br></pre></td></tr></table></figure>
<p>使用主席树来维护”可持久化数组”,具体思路和k-th number不大一样,可是主要结构是一样的。</p>
<h4 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h4><figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span></span><br><span class="line">        n,cnt,hao,tot:longint;</span><br><span class="line">        len,lson,rson,root:<span class="keyword">array</span>[<span class="number">0</span>..<span class="number">2000035</span>] <span class="keyword">of</span> longint;</span><br><span class="line">        value:<span class="keyword">array</span>[<span class="number">0</span>..<span class="number">2000035</span>] <span class="keyword">of</span> char;</span><br><span class="line">        s:<span class="keyword">string</span>;</span><br><span class="line">        HuHa:char;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">procedure</span> <span class="title">build</span><span class="params">(<span class="keyword">var</span> rt:longint; fa,l,r,po:longint)</span>;</span></span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">        mid:longint;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> (rt=<span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">                inc(tot);</span><br><span class="line">                rt:=tot;</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line">        <span class="keyword">if</span> l=r <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">                value[rt]:=HuHa;</span><br><span class="line">                <span class="keyword">exit</span>;</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line">        mid:=(l+r) <span class="keyword">div</span> <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (po&lt;=mid) <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">                rson[rt]:=rson[fa];</span><br><span class="line">                build(lson[rt],lson[fa],l,mid,po);</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line">        <span class="keyword">if</span> (po&gt;=mid+<span class="number">1</span>) <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">                lson[rt]:=lson[fa];</span><br><span class="line">                build(rson[rt],rson[fa],mid+<span class="number">1</span>,r,po);</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Query</span><span class="params">(rt,l,r,po:longint)</span>:</span>char;</span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">        mid:longint;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> l=r <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">exit</span>(value[rt]);</span><br><span class="line">        mid:=(l+r) <span class="keyword">div</span> <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (po&lt;=mid) <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">exit</span>(Query(lson[rt],l,mid,po));</span><br><span class="line">        <span class="keyword">if</span> (po&gt;=mid+<span class="number">1</span>) <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">exit</span>(Query(rson[rt],mid+<span class="number">1</span>,r,po));</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">        readln(n);</span><br><span class="line">        <span class="keyword">while</span> n&gt;<span class="number">0</span> <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">                readln(s);</span><br><span class="line">                <span class="keyword">if</span> s[<span class="number">1</span>]=<span class="string">'T'</span> <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">begin</span></span><br><span class="line">                        HuHa:=s[<span class="number">3</span>];</span><br><span class="line">                        inc(cnt);</span><br><span class="line">                        len[cnt]:=len[cnt-<span class="number">1</span>]+<span class="number">1</span>;</span><br><span class="line">                        Build(root[cnt],root[cnt-<span class="number">1</span>],<span class="number">1</span>,<span class="number">100007</span>,len[cnt]);</span><br><span class="line">                <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> s[<span class="number">1</span>]=<span class="string">'U'</span> <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">begin</span></span><br><span class="line">                        delete(s,<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line">                        val(s,hao);</span><br><span class="line">                        inc(cnt);</span><br><span class="line">                        len[cnt]:=len[cnt-hao-<span class="number">1</span>];</span><br><span class="line">                        root[cnt]:=root[cnt-hao-<span class="number">1</span>];</span><br><span class="line">                <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> s[<span class="number">1</span>]=<span class="string">'Q'</span> <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">begin</span></span><br><span class="line">                        delete(s,<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line">                        val(s,hao);</span><br><span class="line">                        writeln(Query(root[cnt],<span class="number">1</span>,<span class="number">100007</span>,hao));</span><br><span class="line">                <span class="keyword">end</span>;</span><br><span class="line">                dec(n);</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">end</span>.</span><br></pre></td></tr></table></figure>

        </div>
      </div>
    </div>
  </div>
</article>



    <!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <p class="copyright text-muted">
          Theme By <a target="_blank" href="https://github.com/levblanc">Levblanc.</a>
          Inspired By <a target="_blank" href="https://github.com/klugjo/hexo-theme-clean-blog">Clean Blog.</a>
        <p class="copyright text-muted">
          Powered By <a target="_blank" href="https://hexo.io/">Hexo.</a>
        </p>
      </div>
    </div>
  </div>
</footer>


    <!-- After Footer Scripts -->
<script src="/js/highlight.pack.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function(event) {
    var codeBlocks = Array.prototype.slice.call(document.getElementsByTagName('pre'))
    codeBlocks.forEach(function(block, index) {
      hljs.highlightBlock(block);
    });
  });
</script>

  </body>
</html>

